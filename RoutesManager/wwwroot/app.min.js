var app;class ApiController{constructor(n){this.apiBaseUrl=app.API_BASE_URL;this.eventObserver=n;this.init()}init(){this.attachEventListeners()}attachEventListeners(){this.eventObserver.subscribe(this.saveGeoLayer.bind(this),EventType.SAVE_LAYER);this.eventObserver.subscribe(this.deleteGeoLayer.bind(this),EventType.DELETE_LAYER);this.eventObserver.subscribe(this.getMyAreas.bind(this),EventType.MAP_LOADED);this.eventObserver.subscribe(this.loadSettings.bind(this),EventType.LOAD_SETTINGS);this.eventObserver.subscribe(this.saveSettings.bind(this),EventType.SAVE_SETTINGS);this.eventObserver.subscribe(this.findLocation.bind(this),EventType.FIND_LOCATION);this.eventObserver.subscribe(this.findWhat3Words.bind(this),EventType.FIND_3_WORDS);this.eventObserver.subscribe(this.suburbsSearch.bind(this),EventType.SEARCH_SUBURBS);this.eventObserver.subscribe(this.addressesSearch.bind(this),EventType.SEARCH_ADDRESSES);this.eventObserver.subscribe(this.sectionalTitleSearch.bind(this),EventType.SEARCH_SECTIONAL_TITLES)}getMyAreas(){var n=`${this.apiBaseUrl}/geospatial/myareas`;fetch(n,this.createRequestObject("GET",null)).then(function(n){if(!n.ok)throw Error(n.statusText);return n.json()}).then(n=>{var t=[];n.forEach(n=>{t.push(new GeoLayerModel(n.Id,n.LayerName,n.Level,n.Geojson))});this.eventObserver.broadcast(EventType.LAYERS_LOADED,t)}).catch(n=>this.handleApiError(n))}saveGeoLayer(n){var t=`${this.apiBaseUrl}/geospatial/savelayer`;fetch(t,this.createRequestObject("POST",n)).then(function(n){if(!n.ok)throw Error(n.statusText);return n.json()}).then(n=>{this.eventObserver.broadcast(EventType.LAYER_SAVED,new GeoLayerModel(n.Id,n.LayerName,n.Level,n.Geojson))}).catch(n=>this.handleApiError(n))}deleteGeoLayer(n){var t=`${this.apiBaseUrl}/geospatial/deletelayer`;fetch(t,this.createRequestObject("POST",n)).then(function(n){if(!n.ok)throw Error(n.statusText);}).then(()=>{this.eventObserver.broadcast(EventType.LAYER_DELETED,new GeoLayerModel(n.Id,"",0,""))}).catch(n=>this.handleApiError(n))}loadSettings(){var n=`${this.apiBaseUrl}/user/mysettings`;fetch(n,this.createRequestObject("GET",null)).then(function(n){if(!n.ok)throw Error(n.statusText);return n.json()}).then(n=>{this.eventObserver.broadcast(EventType.SETTINGS_LOADED,new UserSettingsModel(n.DefaultMapProvider))}).catch(n=>this.handleApiError(n))}saveSettings(n){var t=`${this.apiBaseUrl}/user/updatesettings`;fetch(t,this.createRequestObject("POST",n)).then(function(n){if(!n.ok)throw Error(n.statusText);}).then(()=>{this.eventObserver.broadcast(EventType.SETTINGS_SAVED,{})}).catch(n=>this.handleApiError(n))}findLocation(n){var t=`${this.apiBaseUrl}/geospatial/findlocation`;fetch(t,this.createRequestObject("POST",n)).then(function(n){if(!n.ok)throw Error(n.statusText);return n.json()}).then(n=>{this.eventObserver.broadcast(EventType.PLOT_LOCATION,new GeoLocationModel(n.LocationId,n.FormattedAddress,n.Lat,n.Lng,n.What3Words,null))}).catch(n=>this.handleApiError(n))}findWhat3Words(n){var t=`${this.apiBaseUrl}/geospatial/findw3w`;fetch(t,this.createRequestObject("POST",n)).then(function(n){if(!n.ok)throw Error(n.statusText);return n.json()}).then(t=>{n.What3Words=t.What3Words,this.eventObserver.broadcast(EventType.W3W_RETRIEVED,n)}).catch(n=>this.handleApiError(n))}suburbsSearch(n){var t=`${this.apiBaseUrl}/geospatial/findmatchingsuburbs?searchText=${n.SearchText}`;fetch(t,this.createRequestObject("GET",null)).then(function(n){if(!n.ok)throw Error(n.statusText);return n.json()}).then(n=>{this.eventObserver.broadcast(EventType.SUBURBS_RETRIEVED,n)}).catch(n=>this.handleApiError(n))}addressesSearch(n){var t=`${this.apiBaseUrl}/geospatial/findmatchingaddresses?searchText=${n.SearchText}&suburbId=${n.SuburbId}`;fetch(t,this.createRequestObject("GET",null)).then(function(n){if(!n.ok)throw Error(n.statusText);return n.json()}).then(n=>{this.eventObserver.broadcast(EventType.ADDRESSES_RETRIEVED,n)}).catch(n=>this.handleApiError(n))}sectionalTitleSearch(n){var t=`${this.apiBaseUrl}/geospatial/findmatchingsectionaltitles?searchText=${n.SearchText}&suburbId=${n.SuburbId}`;fetch(t,this.createRequestObject("GET",null)).then(function(n){if(!n.ok)throw Error(n.statusText);return n.json()}).then(n=>{this.eventObserver.broadcast(EventType.SECTIONAL_TITLES_RETRIEVED,n)}).catch(n=>this.handleApiError(n))}createRequestObject(n,t){var r=t!=null?t.toString():null,i=new Headers;return i.append("Content-Type","application/json"),i.append("Authorization",`Bearer ${localStorage.getItem("access-token")}`),{method:n,body:r,headers:i}}handleApiError(n){console.log(n.message);n.message==="Unauthorized"&&(window.location="unauthorized.html")}}class MapViewController{constructor(n){this.$container=$("#map");this.eventBroker=n;this.mapProvider=null;this.init()}init(){this.attachHandlers();this.attachEventListeners()}onSettingsLoaded(n){switch(n.DefaultMapProvider){case"google":this.mapProvider=new GoogleMapView(this,this.eventBroker);break;case"leaflet":this.mapProvider=new LeafletMapView(this,this.eventBroker)}}attachHandlers(){this.$container.on("click",".saveGeoLayerButton",{},this.saveGeoLayerClickHandler.bind(this));this.$container.on("click",".deleteGeoLayerButton",{},this.deleteGeoLayerClickHandler.bind(this))}attachEventListeners(){this.eventBroker.subscribe(this.onGeoLayerSaving.bind(this),EventType.BEFORE_SAVE_LAYER);this.eventBroker.subscribe(this.onGeoLayerSaved.bind(this),EventType.LAYER_SAVED);this.eventBroker.subscribe(this.onLayerClick.bind(this),EventType.CLICK_LAYER);this.eventBroker.subscribe(this.onSettingsLoaded.bind(this),EventType.SETTINGS_LOADED);this.eventBroker.subscribe(this.onMapLoaded.bind(this),EventType.AFTER_LAYERS_SHOWN);this.eventBroker.subscribe(this.onW3wRetrieved.bind(this),EventType.W3W_RETRIEVED)}saveGeoLayerClickHandler(){var n=$(".layerNameInput"),t,i;if(n.val()===""){n.focus();return}t=$(".layerLevelSelect").val();i=new GeoLayerModel(0,n.val(),t,"");this.eventBroker.broadcast(EventType.BEFORE_SAVE_LAYER,i)}deleteGeoLayerClickHandler(){Swal.fire({title:"Delete Layer?",text:"",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes"}).then(n=>{n.value&&($.blockUI({message:"<h2 class='loading-text'>Deleting Layer...<\/h2>"}),this.eventBroker.broadcast(EventType.BEFORE_DELETE_LAYER,{}))})}onGeoLayerSaving(){$.blockUI({message:"<h2 class='loading-text'>Saving...<\/h2>"});$(".saveGeoLayerButton").val("Saving...").attr("disabled","disabled")}onGeoLayerSaved(){$(".saveGeoLayerButton").val("Save").removeAttr("disabled");$.unblockUI()}onLayerClick(n){$(".layerNameInput").focus().val(n.LayerName?n.LayerName:"")}renderLayerLevelSetting(n){var t="<select class='layerLevelSelect'>";return[{Id:1,Name:"1"},{Id:2,Name:"2"},{Id:3,Name:"3"}].forEach(i=>{var r=i.Id==n.Level?"selected":"",u=`<option value='${i.Id}' ${r}>${i.Name}</option>`;t+=u}),t+"<\/select>"}getGeoLayerPopupContent(n){return`<div>
                    <span>
                        <div class='info-window-item-row'>
                            <label>Layer name: </label>
                            <input class='layerNameInput' type='text' value='${n.LayerName?n.LayerName:""}' />
                        </div>
                        <div class='info-window-item-row'>
                            <label>Priority level: </label>
                            ${this.renderLayerLevelSetting(n)}
                        </div>
                        <p />
                        <input class='saveGeoLayerButton' type='button' value='Save' />
                        <input class='deleteGeoLayerButton' type='button' value='Delete Layer' />
                    </span>
                </div>`}getGeolocationPopupContent(n){return`<div class='info-window-geolocation'>
                    <span>
                        <div class='info-window-item-row'>
                            <label>Address: </label>
                            <input class='layerNameInput' type='text' value='${n.FormattedAddress?n.FormattedAddress:"n/a"}' readonly />
                        </div>
                        <div class='info-window-item-row'>
                            <label>Lat/Lng: </label>
                            <input type='text' value='${n.Lat}, ${n.Lng}' readonly />
                        </div>
                        <div class='info-window-item-row'>
                            <label>What3Words: </label>
                            <input id='w3wInput-${n.uniqueIdentifier()}' type='text' value='${n.What3Words?n.What3Words:"Loading..."}' readonly />
                        </div>
                        <p />
                    </span>
                </div>`}onW3wRetrieved(n){var t=$(`#w3wInput-${n.uniqueIdentifier()}`);t.length&&t.val(n.What3Words)}onMapLoaded(){$.unblockUI()}}class MenuViewController{constructor(n){this.eventBroker=n;this.settingsMenu=new SettingsMenuView(n);this.geoLayersMenu=new GeoLayersMenuView(n);this.locationFinderMenu=new LocationFinderMenuView(n);this.init()}init(){$.blockUI({message:"<h2 class='loading-text'>Loading...<\/h2>"});this.eventBroker.broadcast(EventType.LOAD_SETTINGS,{})}}class AddressSearchModel{constructor(n,t){this.SearchText=n;this.SuburbId=t}toString(){return JSON.stringify(this)}}class GeoLayerModel{constructor(n,t,i,r){this.Id=n;this.LayerName=t;this.Level=i;this.Geojson=r}toString(){return JSON.stringify(this)}}class GeoLocationModel{constructor(n,t,i,r,u,f){this.LocationId=n;this.FormattedAddress=t;this.Lat=i;this.Lng=r;this.What3Words=u;this.ProviderPayload=f}toString(){return JSON.stringify(this)}uniqueIdentifier(){return((this.Lat+90)*180+this.Lng+"").replace(".","")}}class LabelValueModel{constructor(n,t){this.label=n;this.value=t}}class UserSettingsModel{constructor(n){this.DefaultMapProvider=n}toString(){return JSON.stringify(this)}}class GeoLayersMenuView{constructor(n){this.$container=$("#layersMenu");this.eventBroker=n;this.layersCache=null;this.render().attachHandlers().attachEventSubscribers()}render(){return this.$container.append(this.content()),this}attachHandlers(){$("#layersListContainer").on("click",".layerLink",n=>{var t=$(n.currentTarget).data("layerid");this.eventBroker.broadcast(EventType.SELECT_LAYER,new GeoLayerModel(t))});$("#layerLevelSelector").on("click",".showAllLayersCheckbox, .showLevel1Checkbox, .showLevel2Checkbox, .showLevel3Checkbox",n=>{$(n.currentTarget).hasClass("showAllLayersCheckbox")||$(".showAllLayersCheckbox").prop("checked",!1);var t=this.getSelectedLevels();this.eventBroker.broadcast(EventType.TOGGLE_LAYERS,t)});return this}attachEventSubscribers(){return this.eventBroker.subscribe(this.onLayersLoaded.bind(this),EventType.LAYERS_LOADED),this.eventBroker.subscribe(this.onLayerSaved.bind(this),EventType.LAYER_SAVED),this.eventBroker.subscribe(this.toggleSelectableLayers.bind(this),EventType.TOGGLE_LAYERS),this.eventBroker.subscribe(this.onLayerDeleted.bind(this),EventType.LAYER_DELETED),this}getSelectedLevels(){var n=$(".showAllLayersCheckbox").is(":checked")?[1,2,3]:[],t=$(".showLevel1Checkbox").is(":checked")?[1]:[],i=$(".showLevel2Checkbox").is(":checked")?[2]:[],r=$(".showLevel3Checkbox").is(":checked")?[3]:[];return _.union([...n,...t,...i,...r])}onLayerSaved(n){var t=$("#layersListContainer").find(`[data-layerid='${n.Id}']`);if(t.length){t.text(n.LayerName);return}}onLayerDeleted(n){var t=$("#layersListContainer").find(`[data-layerid='${n.Id}']`);t.length&&t.remove()}onLayersLoaded(n){this.layersCache=n;this.updateLayersSelection(this.layersCache)}toggleSelectableLayers(n){var t=_.filter(this.layersCache,t=>_.includes(n,t.Level));this.updateLayersSelection(t)}updateLayersSelection(n){var t=$("#layersListContainer");t.empty();n.forEach(n=>{t.append(this.appendLayerLink(n))})}appendLayerLink(n){return $("<li>").append($("<a>").attr("href","#").addClass("layerLink").text(n.LayerName).attr("data-layerid",n.Id))}content(){return`<div>
                    <div id='layerLevelSelector' class='menu-margins'>
                        <fieldset>
                            <legend>Layer Levels</legend>
                            Show all <input type="checkbox" class="showAllLayersCheckbox align-middle" checked> |
                            Level 1 <input type="checkbox" class="showLevel1Checkbox align-middle"> | 
                            Level 2 <input type="checkbox" class="showLevel2Checkbox align-middle"> | 
                            Level 3 <input type="checkbox" class="showLevel3Checkbox align-middle"> 
                        </fieldset>
                    </div>
                    <p />
                    <div class='menu-margins menu-content-vh'>
                        <ul id='layersListContainer'></ul>
                    </div>
                </div>`}}class GoogleMapView{constructor(n,t){this.viewController=n;this.eventBroker=t;this.map=null;this.selectedLayer=null;this.layerCache=null;this.infowindow=null;this.addFeatureEventHandlerInstance=null;this.init()}init(){this.attachEventListeners().createMapScript().createMapCallback()}attachEventListeners(){return this.eventBroker.subscribe(this.onLayersLoaded.bind(this),EventType.LAYERS_LOADED),this.eventBroker.subscribe(this.onSaveLayer.bind(this),EventType.BEFORE_SAVE_LAYER),this.eventBroker.subscribe(this.onDeleteLayer.bind(this),EventType.BEFORE_DELETE_LAYER),this.eventBroker.subscribe(this.onLayerDeleted.bind(this),EventType.LAYER_DELETED),this.eventBroker.subscribe(this.onLayerSaved.bind(this),EventType.LAYER_SAVED),this.eventBroker.subscribe(this.afterLayersLoaded.bind(this),EventType.AFTER_LAYERS_SHOWN),this.eventBroker.subscribe(this.onSelectLayer.bind(this),EventType.SELECT_LAYER),this.eventBroker.subscribe(this.toggleLayers.bind(this),EventType.TOGGLE_LAYERS),this.eventBroker.subscribe(this.plotLocationMarker.bind(this),EventType.PLOT_LOCATION),this}createMapScript(){var n=document.createElement("script");return n.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQ3eXd26fw0zaOG95D4u5vgki7asjfY4I&callback=initGoogleMap&libraries=drawing,places",document.body.appendChild(n),this}createMapCallback(){return window.initGoogleMap=()=>{try{const t={latitude:-33.945282,longitude:18.597752};this.map=new google.maps.Map(document.getElementById("map"),{mapTypeId:"roadmap",center:{lat:t.latitude,lng:t.longitude},zoom:10});this.enableDrawing();var n=this;this.map.data.addListener("click",t=>{n.handleLayerClick(t.feature),n.handleDeleteVertex(t)});this.map.data.setStyle(n=>{var t=n.getProperty("LayerColour");return{fillColor:t,fillOpacity:.7,strokeWeight:1}});this.infowindow=new google.maps.InfoWindow;this.eventBroker.broadcast(EventType.MAP_LOADED,{})}catch(t){console.log(t)}},this}enableDrawing(){var n=new google.maps.drawing.DrawingManager({drawingControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT,drawingModes:["polygon"]},polygonOptions:{fillColor:"red",strokeWeight:1}}),t;n.setMap(this.map);t=this;google.maps.event.addListener(n,"polygoncomplete",function(i){var f=new Wkt.Wkt,e=f.fromObject(i),o=JSON.stringify({type:"Feature",properties:{Id:0},geometry:e.toJson()}),r=new GeoLayerModel(0,"",0,o),u;t.layerCache.push(r);u=JSON.parse(r.Geojson);t.map.data.addGeoJson(u,{idPropertyName:"Id"});n.setDrawingMode(null);i.setMap(null)})}onLayersLoaded(n){this.layerCache=n;this.layerCache.forEach(n=>{var t=JSON.parse(n.Geojson);this.map.data.addGeoJson(t,{idPropertyName:"Id"})});this.eventBroker.broadcast(EventType.AFTER_LAYERS_SHOWN,{})}toggleLayers(n){this.unselectActiveLayer();this.map.data.forEach(n=>{this.map.data.remove(n)});this.addFeatureEventHandlerInstance.remove();this.addFeatureEventHandlerInstance=null;var t=_.filter(this.layerCache,t=>_.includes(n,t.Level));t.forEach(n=>{var t=JSON.parse(n.Geojson);this.map.data.addGeoJson(t,{idPropertyName:"Id"})});this.eventBroker.broadcast(EventType.AFTER_LAYERS_SHOWN,{})}afterLayersLoaded(){var n=this;this.addFeatureEventHandlerInstance=this.map.data.addListener("addfeature",t=>{n.handleLayerClick(t.feature)})}unselectActiveLayer(){this.infowindow.close();this.selectedLayer&&(this.map.data.overrideStyle(this.selectedLayer,{editable:!1}),this.selectedLayer.getProperty("Id")==0&&this.map.data.remove(this.selectedLayer))}handleLayerClick(n){this.unselectActiveLayer();this.selectedLayer=n;this.map.data.overrideStyle(this.selectedLayer,{editable:!0});var r=this.selectedLayer.getProperty("Id"),t=this.layerCache.find(n=>n.Id==r),i=new GeoLayerModel(t.Id,t.LayerName,t.Level,""),u=this.viewController.getGeoLayerPopupContent(i),f=n.getGeometry().getAt(0).getArray(),e=this.calcCentroid(f);this.infowindow.setContent(u);this.infowindow.setPosition(e);this.infowindow.open(this.map);this.eventBroker.broadcast(EventType.CLICK_LAYER,{LayerName:i.LayerName})}onSaveLayer(n){this.selectedLayer.toGeoJson(t=>{var f=JSON.stringify(t),i=this.selectedLayer.getProperty("Id"),r=this.layerCache.find(n=>n.Id==i),u;r.Geojson=f;u=new GeoLayerModel(i,n.LayerName,n.Level,r.Geojson);this.eventBroker.broadcast(EventType.SAVE_LAYER,u)})}onDeleteLayer(){var n=this.selectedLayer.getProperty("Id"),t=new GeoLayerModel(n,"",0,"");this.eventBroker.broadcast(EventType.DELETE_LAYER,t)}onLayerDeleted(n){this.unselectActiveLayer();this.map.data.remove(this.selectedLayer);_.remove(this.layerCache,t=>t.Id===n.Id);$.unblockUI()}onLayerSaved(n){var t=this.layerCache.find(t=>t.Id==n.Id),i,r;t||(t=this.layerCache.find(n=>n.Id==0));i=JSON.parse(n.Geojson);this.selectedLayer.setProperty("Id",n.Id);r=i.properties.LayerColour;this.map.data.overrideStyle(this.selectedLayer,{fillColor:r,fillOpacity:.7,strokeWeight:1});t.Id=n.Id;t.LayerName=n.LayerName;t.Level=n.Level;t.Geojson=n.Geojson}calcCentroid(n){var t=new google.maps.LatLngBounds;return n.forEach(n=>{t.extend(n)}),t.getCenter()}handleDeleteVertex(n){var t,i,r;n.latLng&&(t=[],n.feature.getGeometry().forEachLatLng(function(i){i.lat()==n.latLng.lat()&&i.lng()==n.latLng.lng()||t.push(i)}),i=new google.maps.Data.LinearRing(t),r=new google.maps.Data.Polygon([i]),n.feature.setGeometry(r))}onSelectLayer(n){var t=this.map;t.data.forEach(i=>{var f=i.getProperty("Id"),r,u;f==n.Id&&(google.maps.event.trigger(t.data,"click",{feature:i}),r=i.getGeometry().getAt(0).getArray(),u=this.calcCentroid(r),t.panTo(u))})}plotLocationMarker(n){$.unblockUI();var r=new google.maps.LatLng(n.Lat,n.Lng),i=new google.maps.Marker({position:r,map:this.map}),u=this.viewController.getGeolocationPopupContent(n),t=this;i.addListener("click",function(){t.infowindow.close();t.infowindow.setContent(t.viewController.getGeolocationPopupContent(n));t.infowindow.open(t.map,i)});this.map.panTo(i.getPosition());this.infowindow.setContent(u);this.infowindow.open(this.map,i);n.What3Words||this.eventBroker.broadcast(EventType.FIND_3_WORDS,n)}}class LeafletMapView{constructor(n,t){this.viewController=n;this.eventBroker=t;this.map=null;this.activeLayer=null;this.drawnItems=null;this.layersCache=null;this.init()}init(){this.createMap().attachEventListeners()}createMap(){try{const n={latitude:-33.945282,longitude:18.597752};this.map=L.map("map",{center:[n.latitude,n.longitude],zoom:10,dragging:!0});L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZGFuaWUzMzAiLCJhIjoiY2pxeTlqc242MDE5cTQzcnpubHlyeTJucyJ9.Omq9E98-rSVM2EWccOdFtg",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap<\/a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA<\/a>, Imagery © <a href="https://www.mapbox.com/">Mapbox<\/a>',maxZoom:30,id:"mapbox.streets",accessToken:"pk.eyJ1IjoiZGFuaWUzMzAiLCJhIjoiY2pxeTlqc242MDE5cTQzcnpubHlyeTJucyJ9.Omq9E98-rSVM2EWccOdFtg"}).addTo(this.map);this.enableDrawing();this.eventBroker.broadcast(EventType.MAP_LOADED,{})}catch(n){console.log(n)}return this}attachEventListeners(){return this.eventBroker.subscribe(this.onSaveLayer.bind(this),EventType.BEFORE_SAVE_LAYER),this.eventBroker.subscribe(this.onDeleteLayer.bind(this),EventType.BEFORE_DELETE_LAYER),this.eventBroker.subscribe(this.onLayerDeleted.bind(this),EventType.LAYER_DELETED),this.eventBroker.subscribe(this.onLayerSaved.bind(this),EventType.LAYER_SAVED),this.eventBroker.subscribe(this.onLayersLoaded.bind(this),EventType.LAYERS_LOADED),this.eventBroker.subscribe(this.onSelectLayer.bind(this),EventType.SELECT_LAYER),this.eventBroker.subscribe(this.toggleLayers.bind(this),EventType.TOGGLE_LAYERS),this}enableDrawing(){var t,n;this.map.options.drawControl=!0;this.drawnItems=new L.FeatureGroup;this.map.addLayer(this.drawnItems);t=new L.Control.Draw({position:"topright",draw:{polygon:{shapeOptions:{color:"red",weight:1}},rectangle:!1,circle:!1,polyline:!1,marker:!1,circlemarker:!1}});this.map.addControl(t);n=this;this.map.on(L.Draw.Event.CREATED,function(t){var r=t.layer,i=r.feature=r.feature||{},u;i.type=i.type||"Feature";i.properties=i.properties||{};i.properties.Id=0;u=new GeoLayerModel(0,"",0,"");n.layersCache.push(u);n.drawnItems.addLayer(t.layer);t.layer.on("click",()=>{n.handleLayerClick(t.layer)}).fireEvent("click")});return this}onSaveLayer(n){var t=this.activeLayer.toGeoJSON(),i=t.properties.Id||0;this.eventBroker.broadcast(EventType.SAVE_LAYER,new GeoLayerModel(i,n.LayerName,n.Level,t))}onDeleteLayer(){var n=this.activeLayer.toGeoJSON(),t=n.properties.Id||0;this.eventBroker.broadcast(EventType.DELETE_LAYER,new GeoLayerModel(t,"",0,""))}onLayerDeleted(n){this.unselectActiveLayer();var t=this;this.map.eachLayer(function(i){if(typeof i.toGeoJSON!="undefined"){var r=i.toGeoJSON();_.has(r,"properties")&&r.properties.Id==n.Id&&t.map.removeLayer(i)}});_.remove(this.layersCache,t=>t.Id===n.Id);$.unblockUI()}onLayerSaved(n){var t=this.layersCache.find(t=>t.Id==n.Id);t||(t=this.layersCache.find(n=>n.Id==0));this.activeLayer.feature.properties.Id=n.Id;this.activeLayer.setStyle({color:JSON.parse(n.Geojson).properties.LayerColour,weight:1,fillOpacity:.7});t.Id=n.Id;t.LayerName=n.LayerName;t.Level=n.Level;t.Geojson=n.Geojson}toggleLayers(n){var t,i;this.unselectActiveLayer();t=this;this.map.eachLayer(function(n){if(typeof n.toGeoJSON!="undefined"){var i=n.toGeoJSON();_.has(i,"properties")&&t.map.removeLayer(n)}});i=_.filter(this.layersCache,t=>_.includes(n,t.Level));i.forEach(n=>{L.geoJson(JSON.parse(n.Geojson),{onEachFeature:function(n,i){var r=n.properties.LayerColour;i.setStyle({color:r,weight:1,fillOpacity:.7});i.on("click",()=>t.handleLayerClick(i));t.drawnItems.addLayer(i)}})});this.eventBroker.broadcast(EventType.AFTER_LAYERS_SHOWN,{})}unselectActiveLayer(){if(this.activeLayer){this.activeLayer.editing.disable();var n=this.activeLayer.toGeoJSON();n.properties.Id==0&&this.map.removeLayer(this.activeLayer)}}handleLayerClick(n){this.unselectActiveLayer();this.activeLayer=n;this.activeLayer.editing.enable();var i=this.activeLayer.toGeoJSON(),t=this.layersCache.find(n=>n.Id==i.properties.Id);t||(t=this.layersCache.find(n=>n.Id==0));this.activeLayer.bindPopup(this.viewController.getGeoLayerPopupContent(t)).openPopup();this.eventBroker.broadcast(EventType.CLICK_LAYER,t)}onLayersLoaded(n){this.layersCache=n;var t=this;this.layersCache.forEach(n=>{L.geoJson(JSON.parse(n.Geojson),{onEachFeature:function(n,i){var r=n.properties.LayerColour;i.setStyle({color:r,weight:1,fillOpacity:.7});i.on("click",()=>t.handleLayerClick(i));t.drawnItems.addLayer(i)}})});this.eventBroker.broadcast(EventType.AFTER_LAYERS_SHOWN,{})}onSelectLayer(n){var t=this.map;t.eachLayer(function(i){var r,u;typeof i.toGeoJSON!="undefined"&&(r=i.toGeoJSON(),_.has(r,"properties")&&r.properties.Id==n.Id&&(i.fireEvent("click"),u=i.getPopup().getLatLng(),t.panTo(u)))})}}class LocationFinderMenuView{constructor(n){this.$container=$("#locationFinderMenu");this.eventBroker=n;this.settings=null;this.suburbsAutocompleteCallback=null;this.addressAutoCompleteCallback=null;this.sectionalTitleAutoCompleteCallback=null;this.attachHandlers().attachEventSubscribers()}render(){this.$container.append(this.content());var n=this,t=0;return $("#localSuburbSearchTextField").autocomplete({minLength:3,delay:500,source:function(t,i){var r=new AddressSearchModel(t.term,0);n.eventBroker.broadcast(EventType.SEARCH_SUBURBS,r);n.suburbsAutocompleteCallback=i},select:function(n,i){n.preventDefault();$(this).val(i.item.label);t=i.item.value;$("#localAddressSearchTextField").val("").prop("disabled",!1);$("#localSectionalTitleSearchTextField").val("").prop("disabled",!1)},change:function(n,t){t.item==null&&($("#localAddressSearchTextField").val("").prop("disabled",!0),$("#localSectionalTitleSearchTextField").val("").prop("disabled",!0))}}),$("#localAddressSearchTextField").autocomplete({minLength:3,delay:500,source:function(i,r){var u=new AddressSearchModel(i.term,t);n.eventBroker.broadcast(EventType.SEARCH_ADDRESSES,u);n.addressAutoCompleteCallback=r},select:function(t,i){$.blockUI({message:"<h2 class='loading-text'>Finding Location...<\/h2>"});t.preventDefault();$(this).val(i.item.label);var r=new GeoLocationModel(i.item.value,"",0,0,null,null);n.eventBroker.broadcast(EventType.FIND_LOCATION,r)}}),$("#localSectionalTitleSearchTextField").autocomplete({minLength:3,delay:500,source:function(i,r){var u=new AddressSearchModel(i.term,t);n.eventBroker.broadcast(EventType.SEARCH_SECTIONAL_TITLES,u);n.sectionalTitleAutoCompleteCallback=r},select:function(t,i){$.blockUI({message:"<h2 class='loading-text'>Finding Location...<\/h2>"});t.preventDefault();$(this).val(i.item.label);var r=new GeoLocationModel(i.item.value,"",0,0,null,null);n.eventBroker.broadcast(EventType.FIND_LOCATION,r)}}),this}attachHandlers(){$("#locationFinderMenu").on("keyup","#w3wSearchField",n=>{if(n.keyCode==13){var t=$("#w3wSearchField").val();t&&this.handleSearchW3W(t)}});return this}attachEventSubscribers(){return this.eventBroker.subscribe(this.initSettings.bind(this),EventType.SETTINGS_LOADED),this.eventBroker.subscribe(this.onMapLoaded.bind(this),EventType.MAP_LOADED),this.eventBroker.subscribe(this.onSuburbsRetrieved.bind(this),EventType.SUBURBS_RETRIEVED),this.eventBroker.subscribe(this.onAddressesRetrieved.bind(this),EventType.ADDRESSES_RETRIEVED),this.eventBroker.subscribe(this.onSectionalTitlesRetrieved.bind(this),EventType.SECTIONAL_TITLES_RETRIEVED),this}initSettings(n){this.settings=n}onMapLoaded(){if(this.settings.DefaultMapProvider==="google"){this.render();var n=new google.maps.places.Autocomplete(document.getElementById("googleSearchTextField"),{strictBounds:!0,componentRestrictions:{country:"za"}});n.setFields(["address_components","geometry","formatted_address","place_id"]);n.addListener("place_changed",()=>this.handleGoogleLocationSelect(n))}else this.$container.empty().append("<div class='menu-margins'>Please switch to Google Maps view to use this function<\/div>")}handleGoogleLocationSelect(n){var t=n.getPlace(),i=JSON.stringify(t),r=new GeoLocationModel(0,t.formatted_address,t.geometry.location.lat(),t.geometry.location.lng(),null,i);$.blockUI({message:"<h2 class='loading-text'>Finding Location...<\/h2>"});this.eventBroker.broadcast(EventType.FIND_LOCATION,r)}handleSearchW3W(n){$.blockUI({message:"<h2 class='loading-text'>Finding Location...<\/h2>"});this.eventBroker.broadcast(EventType.FIND_LOCATION,new GeoLocationModel(0,null,0,0,n,null))}onSuburbsRetrieved(n){this.suburbsAutocompleteCallback(n)}onAddressesRetrieved(n){this.addressAutoCompleteCallback(n)}onSectionalTitlesRetrieved(n){this.sectionalTitleAutoCompleteCallback(n)}content(){return`<div class='menu-margins'>                    
                    <span class='menu-search-header underline'>Local Search</span>
<div class='menu-label-input'>
                    <label>Suburb: </label>
                    <input id='localSuburbSearchTextField' type='search' class='inline-search-box' />
                    </div>
<div class='menu-label-input'>
                    <label>Address: </label>
                    <input id='localAddressSearchTextField' type='search' class='inline-search-box' disabled />
                    </div>
<div class='menu-label-input'>
                    <label>SS Name: </label>
                    <input id='localSectionalTitleSearchTextField' type='search' class='inline-search-box' disabled />
                    </div>
                    <p />
                    <img src='../../img/google_logo.jpg' class='menu-search-logo' />
                    <input id='googleSearchTextField' type='search' class='search-box' />
                    <p />
                    <img src='../../img/w3w_logo.png' class='menu-search-logo' />
                    <input id='w3wSearchField' type='search' class='search-box' placeholder='Enter.three.words ...' />
                </div>`}}class SettingsMenuView{constructor(n){this.googleIdentifier="google";this.leafletIdentifier="leaflet";this.$container=$("#settingsMenu");this.eventBroker=n;this.render().attachHandlers().attachEventSubscribers()}render(){return this.$container.append(this.content()),this}attachEventSubscribers(){return this.eventBroker.subscribe(this.onSaveSettings.bind(this),EventType.BEFORE_SAVE_SETTINGS),this.eventBroker.subscribe(this.onSettingsSaved.bind(this),EventType.SETTINGS_SAVED),this.eventBroker.subscribe(this.onSettingsLoaded.bind(this),EventType.SETTINGS_LOADED),this}attachHandlers(){return $("#saveSettingsButton").click(()=>this.eventBroker.broadcast(EventType.BEFORE_SAVE_SETTINGS,{})),$("#refreshSettingsButton").click(()=>location.reload()),this}onSaveSettings(){$("#saveSettingsButton").val("Saving...").attr("disabled","disabled");var n=$("#mapProviderToggle").val(),t=new UserSettingsModel(n);this.eventBroker.broadcast(EventType.SAVE_SETTINGS,t)}onSettingsSaved(){$("#saveSettingsButton").val("Save Changes").removeAttr("disabled")}onSettingsLoaded(n){var t=n.DefaultMapProvider;$("#mapProviderToggle").val(t)}content(){return`<div class='menu-margins'>
                    <span>
                        <label>Default map provider: </label>
                        <select id='mapProviderToggle'>
                            <option value='leaflet'>Leaflet</option>
                            <option value='google'>Google Maps</option>
                        </select>
                    </span>
                    <p />
                    <span>
                        <input id='saveSettingsButton' type='button' value='Save Changes' />
                        <input id='refreshSettingsButton' class='float-right' type='button' value='Refresh Application' />
                    </span>
                </div>`}}app=app||{},function(n){$(function(){var t=new EventBroker;new ApiController(t);new MenuViewController(t);new MapViewController(t);n.createMenu()});n.createMenu=()=>$(".slide-menu").slidemenu()}(app);app=app||{};app.API_BASE_URL="http://localhost:8000/api";app.LOGIN_URL="http://localhost:8000/api/user/login";app.DEFAULT_PAGE="index.html";const EventType={BEFORE_SAVE_LAYER:"BEFORE_SAVE_LAYER",SAVE_LAYER:"SAVE_LAYER",LAYER_SAVED:"LAYER_SAVED",CLICK_LAYER:"CLICK_LAYER",SELECT_LAYER:"SELECT_LAYER",BEFORE_DELETE_LAYER:"BEFORE_DELETE_LAYER",DELETE_LAYER:"DELETE_LAYER",LAYER_DELETED:"LAYER_DELETED",MAP_LOADED:"MAP_LOADED",PLOT_LOCATION:"PLOT_LOCATION",LAYERS_LOADED:"LAYERS_LOADED",AFTER_LAYERS_SHOWN:"AFTER_LAYERS_SHOWN",TOGGLE_LAYERS:"TOGGLE_LAYERS",BEFORE_SAVE_SETTINGS:"BEFORE_SAVE_SETTINGS",SAVE_SETTINGS:"SAVE_SETTINGS",SETTINGS_SAVED:"SETTINGS_SAVED",LOAD_SETTINGS:"LOAD_SETTINGS",SETTINGS_LOADED:"SETTINGS_LOADED",FIND_LOCATION:"FIND_LOCATION",SEARCH_SUBURBS:"SEARCH_SUBURBS",SUBURBS_RETRIEVED:"SUBURBS_RETRIEVED",SEARCH_ADDRESSES:"SEARCH_ADDRESSES",ADDRESSES_RETRIEVED:"ADDRESSES_RETRIEVED",SEARCH_SECTIONAL_TITLES:"SEARCH_SECTIONAL_TITLES",SECTIONAL_TITLES_RETRIEVED:"SECTIONAL_TITLES_RETRIEVED",FIND_3_WORDS:"FIND_3_WORDS",W3W_RETRIEVED:"W3W_RETRIEVED"};class EventBroker{constructor(){this.subscribers={BEFORE_SAVE_LAYER:[],SAVE_LAYER:[],LAYER_SAVED:[],CLICK_LAYER:[],SELECT_LAYER:[],BEFORE_DELETE_LAYER:[],DELETE_LAYER:[],LAYER_DELETED:[],MAP_LOADED:[],PLOT_LOCATION:[],LAYERS_LOADED:[],AFTER_LAYERS_SHOWN:[],TOGGLE_LAYERS:[],BEFORE_SAVE_SETTINGS:[],SAVE_SETTINGS:[],SETTINGS_SAVED:[],LOAD_SETTINGS:[],SETTINGS_LOADED:[],FIND_LOCATION:[],SEARCH_SUBURBS:[],SUBURBS_RETRIEVED:[],SEARCH_ADDRESSES:[],ADDRESSES_RETRIEVED:[],SEARCH_SECTIONAL_TITLES:[],SECTIONAL_TITLES_RETRIEVED:[],FIND_3_WORDS:[],W3W_RETRIEVED:[]}}subscribe(n,t){this.subscribers[t].push(n)}broadcast(n,t){var r,i;for(console.log(`${n} event broadcast by EventBroker`),r=this.subscribers[n],i=0;i<r.length;i++)r[i](t)}}